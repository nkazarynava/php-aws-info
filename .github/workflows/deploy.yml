name: Build and Deploy to EC2

on:
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install Composer
        run: |
          php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
          php composer-setup.php --install-dir=/usr/local/bin --filename=composer
          php -r "unlink('composer-setup.php');"

      - name: Install PHP Dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Create ZIP Artifact
        run: zip -r php-aws-info.zip public get-aws-metadata.php composer.json composer.lock vendor

      - name: Setup SSH Key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > ${{ secrets.EC2_KEY_FILE_NAME }}
          chmod 600 ${{ secrets.EC2_KEY_FILE_NAME }}

      - name: Copy ZIP to EC2
        run: |
          scp -i ${{ secrets.EC2_KEY_FILE_NAME }} -o StrictHostKeyChecking=no php-aws-info.zip ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/

      - name: SSH and Deploy on EC2
        run: |
          ssh -i ${{ secrets.EC2_KEY_FILE_NAME }} -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            sudo unzip -o /tmp/php-aws-info.zip -d /var/www/html
            sudo chown -R apache:apache /var/www/html
          EOF